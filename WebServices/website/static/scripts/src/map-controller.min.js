var DEFAULT_LAT=42.6;var DEFAULT_LNG=-8.933;var DEFAULT_ZOOM=6;var DEFAULT_GS_ELEVATION=15;var USER_ZOOM=8;var TIMESTAMP_FORMAT="HH:mm:ss.sss";function centerMap(d,c,a,b){d.setView(new L.LatLng(c,a),b)}function locateUser(b,c,a){$.get("http://ipinfo.io",function(e){var g=e.loc.split(",");var f=parseFloat(g[0]);var d=parseFloat(g[1]);b.info("[map-ctrl] User located at = "+g);centerMap(c,f,d,USER_ZOOM);if(a!=null){a.lat=f;a.lng=d}},"jsonp").fail(function(){b.warn("[map-ctrl] Could not locate user");centerMap(c,DEFAULT_LAT,DEFAULT_LNG,DEFAULT_ZOOM);if(a!=null){a.lat=DEFAULT_LAT;a.lng=DEFAULT_LNG}})}var app=angular.module("satellite.tracker.js",["leaflet-directive","ui.bootstrap","nya.bootstrap.select","ngResource","ngCookies","remoteValidation","jsonrpc"]);app.config(function(a){a.decorator("$log",function(b){var c=null;return{setScope:function(d){c=d},log:function(){b.log.apply(null,["[log] "+arguments[0]]);c.$broadcast("logEvent",arguments[0])},info:function(){b.info.apply(null,["[info] "+arguments[0]]);c.$broadcast("infoEvent",arguments[0])},error:function(){b.error.apply(null,["[error] "+arguments[0]]);c.$broadcast("errEvent",arguments[0])},warn:function(){b.warn.apply(null,["[warn] "+arguments[0]]);c.$broadcast("warnEvent",arguments[0])}}})});app.service("celestrak",function(a){this.readTLE=function(e,d){var c=__CELESTRAK_RESOURCES[e];var b=getCORSSURL(c);return a.get(b).success(function(f){d(readTLEs(f))}).error(function(f){throw"[celestrak] Error = "+JSON.stringify(f)})}});app.service("satnetRPC",function(a,d,c){var b=""+d.protocol()+"://"+d.host()+":"+d.port()+"/jrpc/";this._cfg_service=a.newService("configuration",b);this._services={"gs.list":this._cfg_service.createMethod("gs.list"),"gs.add":this._cfg_service.createMethod("gs.create"),"gs.get":this._cfg_service.createMethod("gs.getConfiguration"),"gs.update":this._cfg_service.createMethod("gs.setConfiguration"),"gs.delete":this._cfg_service.createMethod("gs.delete"),"sc.list":this._cfg_service.createMethod("sc.list"),"sc.add":this._cfg_service.createMethod("sc.create"),"sc.get":this._cfg_service.createMethod("sc.getConfiguration"),"sc.update":this._cfg_service.createMethod("sc.setConfiguration"),"sc.delete":this._cfg_service.createMethod("sc.delete")};this._errorCb=function(e){c.warn('[satnet-jrpc] Error calling "satnetRPC" = '+JSON.stringify(e))};this.call=function(e,f,h,g){if(!e in this._services){throw'"satnetRPC" service not found, id = '+e}if(g==null){g=this._errorCb}this._services[e](f).success(h).error(g)}});app.service("gs",function(a,b){this._gsCfg={};this.create=function(g){var e=g.groundstation_id;var h=L.latLng(g.groundstation_latlon[0],g.groundstation_latlon[1]);var f=L.icon({iconUrl:"/static/images/icons/gs-icon.svg",iconSize:[30,30]});var d=e+"@"+g.groundstation_callsign;var c=L.marker(h,{draggable:false,icon:f}).bindLabel(d,{noHide:true});this._gsCfg[e]={marker:c,cfg:g};return c};this.remove=function(c){if(!c in this._gsCfg){b.warn("[markers] No marker for gs, id= "+c);return}a._map.removeLayer(this._gsCfg[c]["marker"]);delete this._gsCfg[c]};this.configure=function(f){var k=f.groundstation_id;if(!k in this._gsCfg){b.warn("[markers] No marker for gs, id= "+k);return}b.info("gs_id = "+k);var j=this._gsCfg[k].cfg.groundstation_callsign;var d=f.groundstation_callsign;if(d!=j){this.remove(k);this.create(f)}else{var e=false;var c=f.groundstation_latlon[0];var g=f.groundstation_latlon[1];var h=this._gsCfg[k].cfg.groundstation_latlon[0];var l=this._gsCfg[k].cfg.groundstation_latlon[1];if(c!=h){e=true}if(g!=l){e=true}if(e==true){var i=L.latLng(c,g);this._gsCfg[k].cfg.groundstation_latlon[0]=c;this._gsCfg[k].cfg.groundstation_latlon[1]=g;this._gsCfg[k].marker.setLatLng(i)}}}});app.service("xSatnetRPC",function(a,c,b){this.addGSMarker=function(d){c.call("gs.get",[d],function(e){b.create(e).addTo(a._map)})};this.initGSMarkers=function(){c.call("gs.list",[],function(e){for(var d=0;d<e.length;d++){c.call("gs.get",[e[d]],function(f){b.create(f).addTo(a._map)})}})};this.updateGSMarker=function(d){c.call("gs.get",[d],function(e){b.configure(e)})}});app.service("broadcaster",function(a){this.__GS_ADDED_EVENT="gs.added";this.__GS_REMOVED_EVENT="gs.removed";this.__GS_UPDATED_EVENT="gs.updated";this.gsAdded=function(b){a.$broadcast(this.__GS_ADDED_EVENT,b)};this.gsRemoved=function(b){a.$broadcast(this.__GS_REMOVED_EVENT,b)};this.gsUpdated=function(b){a.$broadcast(this.__GS_UPDATED_EVENT,b)}});app.run(function(b,d,e,c,a){d.setScope(b);e.defaults.headers.post["X-CSRFToken"]=c.csrftoken;a.getMap().then(function(f){b._map=f})});app.controller("NotificationAreaController",function(a,b){a.eventLog=[];a.$on("infoEvent",function(d,c){a.eventLog.unshift({type:d.name,timestamp:b("date")(new Date(),TIMESTAMP_FORMAT),msg:c})})});app.controller("MapController",function(d,f,b,e,a,c){d.markers=[];angular.extend(d,{center:{lat:DEFAULT_LAT,lng:DEFAULT_LNG,zoom:DEFAULT_ZOOM},defaults:{worldCopyJump:true}});b.getMap().then(function(g){locateUser(f,g,null);L.terminator({fillOpacity:0.125}).addTo(g);e.initGSMarkers()});d.$on(a.__GS_ADDED_EVENT,function(h,g){e.addGSMarker(g)});d.$on(a.__GS_REMOVED_EVENT,function(h,g){c.remove(g)});d.$on(a.__GS_UPDATED_EVENT,function(h,g){e.updateGSMarker(g)})});app.controller("GSMenuCtrl",function(a,d,b,c){a.gsIds=[];a.addGroundStation=function(){var e=b.open({templateUrl:"/static/scripts/src/templates/addGroundStation.html",controller:"AddGSModalCtrl",backdrop:"static"})};a.editGroundStation=function(f){var e=b.open({templateUrl:"/static/scripts/src/templates/editGroundStation.html",controller:"EditGSModalCtrl",backdrop:"static",resolve:{groundstationId:function(){return(f)}}})};a.refreshGSList=function(){c.call("gs.list",[],function(e){a.gsIds=e.slice(0)})};a.refreshGSList()});app.controller("SCMenuCtrl",function(a,d,b,c){a.scIds=[];a.addSpacecraft=function(){var e=b.open({templateUrl:"/static/scripts/src/templates/addSpacecraft.html",controller:"AddSCModalCtrl",backdrop:"static"})};a.editSpacecraft=function(f){var e=b.open({templateUrl:"/static/scripts/src/templates/editSpacecraft.html",controller:"EditSCModalCtrl",backdrop:"static",resolve:{spacecraftId:function(){return(f)}}})};a.refreshSCList=function(){c.call("sc.list",[],function(e){a.scIds=e.slice(0)})};a.refreshSCList()});app.controller("ExitMenuCtrl",function(a,b){a.home=function(){b.info("Exiting...")}});app.controller("AddGSModalCtrl",function(c,f,e,b,d,a){c.gs={};c.gs.identifier="";c.gs.callsign="";c.gs.elevation=DEFAULT_GS_ELEVATION;angular.extend(c,{center:{lat:DEFAULT_LAT,lng:DEFAULT_LNG,zoom:DEFAULT_ZOOM},markers:{gsMarker:{lat:DEFAULT_LAT,lng:DEFAULT_LNG,message:"Move me!",focus:true,draggable:true}}});b.getMap().then(function(g){locateUser(f,g,c.markers.gsMarker)});c.ok=function(){var g=[c.gs.identifier,c.gs.callsign,c.gs.elevation.toFixed(2),c.markers.gsMarker.lat.toFixed(6),c.markers.gsMarker.lng.toFixed(6)];d.call("gs.add",g,function(i){var h=i.groundstation_id;f.info("[map-ctrl] GS added, id = "+h);a.gsAdded(h)});e.close()};c.cancel=function(){e.close()}});app.controller("EditGSModalCtrl",function(c,g,f,b,e,a,d){c.gs={};c.center={lat:DEFAULT_LAT,lng:DEFAULT_LNG,zoom:DEFAULT_ZOOM};c.markers={};e.call("gs.get",[d],function(h){c.gs.identifier=d;c.gs.callsign=h.groundstation_callsign;c.gs.elevation=h.groundstation_elevation;angular.extend(c,{center:{lat:h.groundstation_latlon[0],lng:h.groundstation_latlon[1],zoom:DEFAULT_ZOOM},markers:{gsMarker:{lat:h.groundstation_latlon[0],lng:h.groundstation_latlon[1],message:"Move me!",focus:true,draggable:true}}})});c.update=function(){var h={groundstation_id:d,groundstation_callsign:c.gs.callsign,groundstation_elevation:c.gs.elevation.toFixed(2),groundstation_latlon:[c.markers.gsMarker.lat.toFixed(6),c.markers.gsMarker.lng.toFixed(6)]};e.call("gs.update",[d,h],function(i){g.info("[map-ctrl] GS updated, id = "+i);a.gsUpdated(i)});f.close()};c.cancel=function(){f.close()};c.erase=function(){if(confirm("Delete this ground station?")==true){e.call("gs.delete",[d],function(h){g.info("[map-ctrl] GS removed, id = "+h);a.gsRemoved(h)});f.close()}}});app.controller("AddSCModalCtrl",function(a,e,d,c,b){a.sc={identifier:"",callsign:"",tlegroup:"",tleid:""};a.tlegroups=__CELESTRAK_SELECT_SECTIONS;a.tles=[];a.initTles=function(f){a.tles=b.readTLE(value.subsection,function(g){a.tles=g.slice(0)});a.sc.tlegroup=f};a.groupChanged=function(f){a.tles=b.readTLE(f.subsection,function(g){a.tles=g.slice(0)})};a.ok=function(){var f=[a.sc.identifier,a.sc.callsign,a.sc.tleid.id];c.call("sc.add",f,function(g){e.info("[map-ctrl] SC added, id = "+g.spacecraft_id)});d.close()};a.cancel=function(){d.close()}});app.controller("EditSCModalCtrl",function(a,e,d,c,b,f){a.sc={identifier:f,callsign:"",tlegroup:"",tleid:"",saved_tleid:""};a.tlegroups=__CELESTRAK_SELECT_SECTIONS;a.tles=[];c.call("sc.get",[f],function(g){a.sc.identifier=f;a.sc.callsign=g.spacecraft_callsign;a.sc.saved_tleid=g.spacecraft_tle_id});a.initTles=function(g){a.tles=b.readTLE(value.subsection,function(h){a.tles=h.slice(0)});a.sc.tlegroup=g};a.groupChanged=function(g){a.tles=b.readTLE(g.subsection,function(h){a.tles=h.slice(0)})};a.update=function(){var g={spacecraft_id:f,spacecraft_callsign:a.sc.callsign,spacecraft_tle_id:a.sc.tleid.id};c.call("sc.update",[f,g],function(h){e.info("[map-ctrl] SC updated, id = "+h)});d.close()};a.cancel=function(){d.close()};a.erase=function(){if(confirm("Delete this spacecraft?")==true){c.call("sc.delete",[f],function(g){e.info("[map-ctrl] Spacecraft removed, id = "+g)});d.close()}}});